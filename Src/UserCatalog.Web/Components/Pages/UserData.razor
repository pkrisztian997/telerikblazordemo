@page "/users"
@using System.Xml.Serialization
@using System.Text
@using SHD.UserCatalog.BL
@using System.Security
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Users</PageTitle>

@* <input placeholder="Search..." @bind="_searchTerm" @bind:event="oninput" /> *@
<TelerikTextBox @bind-Value="_searchTerm"
                Placeholder="Search..."
                OnChange="@OnSearchTermChanged" />

<TelerikGrid Data="@_filteredUsers" Height="500px"
             Pageable="true"
             Sortable="true"
             FilterMode="Telerik.Blazor.GridFilterMode.None"
             SelectedItems="@_selectedUsers"
             SelectionMode="GridSelectionMode.Multiple"
             SelectedItemsChanged="@((IEnumerable<IUser> newSelected) => OnRowSelect(newSelected))">
    <GridColumns>
        <GridColumn Field="Username" Title="Username" />
        <GridColumn Field="FirstName" Title="Firstname" />
        <GridColumn Field="LastName" Title="Lastname" />
        <GridColumn Field="DateOfBirth" Title="Date of birth" />
        <GridColumn Field="BirthPlace" Title="Birth place" />
        <GridColumn Field="Residence" Title="Residence" />
    </GridColumns>
</TelerikGrid>

<div class="mt-3">
    <TelerikButton Class="btn btn-primary" OnClick="@ExportToXml"
                   Enabled="@(_selectedUsers.Any())">
        XML Mentés
    </TelerikButton>

    <TelerikButton Class="btn btn-success" OnClick="@GoToDetail"
                   Enabled="@(_selectedUsers.Any())">
        Módosítás
    </TelerikButton>
</div>

@code {
    private IEnumerable<IUser> _users = new List<IUser>();
    private IEnumerable<IUser> _filteredUsers = new List<IUser>();

    private string _searchTerm = string.Empty;
    private IEnumerable<IUser> _selectedUsers = new List<IUser>();

    protected override async Task OnInitializedAsync()
    {
        _users = await LoadUsersAsync();
        _filteredUsers = _users;
    }

    private async Task<IEnumerable<IUser>> LoadUsersAsync()
    {
        var response = await Http.GetAsync("/api/user");
        if (!response.IsSuccessStatusCode)
        {
            return new List<IUser>();
        }

        var json = await response.Content.ReadAsStringAsync();

        var doc = System.Text.Json.JsonDocument.Parse(json);
        var list = new List<IUser>();

        foreach (var element in doc.RootElement.EnumerateArray())
        {
            list.Add(new UserProxy()
            {
                Id = element.GetProperty("id").GetGuid(),
                Username = element.GetProperty("username").GetString()!,
                FirstName = element.GetProperty("firstName").GetString()!,
                LastName = element.GetProperty("lastName").GetString()!,
                DateOfBirth = element.GetProperty("dateOfBirth").GetDateTime(),
                BirthPlace = element.GetProperty("birthPlace").GetString()!,
                Residence = element.GetProperty("residence").GetString()!,
                Password = new System.Security.SecureString()
            });
        }

        return list;
    }

    private void OnRowSelect(IEnumerable<IUser> users)
    {
        _selectedUsers = users;
    }

    private void ExportToXml()
    {
        var proxyList = _selectedUsers.Select(u => new UserProxy
        {
            Id = u.Id,
            Username = u.Username,
            FirstName = u.FirstName,
            LastName = u.LastName,
            DateOfBirth = u.DateOfBirth,
            BirthPlace = u.BirthPlace,
            Residence = u.Residence,
            Password = u.Password
        }).ToList();

        var serializer = new XmlSerializer(typeof(List<UserProxy>));
        using var sw = new StringWriter();
        serializer.Serialize(sw, proxyList);
        var xml = sw.ToString();

        var bytes = Encoding.UTF8.GetBytes(xml);
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"users_{DateTime.Now:yyyyMMddHHmmss}.xml";
        var href = $"data:text/xml;base64,{base64}";
        JS.InvokeVoidAsync("downloadFile", href, fileName);
    }

    private void GoToDetail()
    {
        var userId = _selectedUsers.First().Id;
        Nav.NavigateTo($"/userdetail/{userId}");
    }

    private void OnSearchTermChanged(object currentValue)
    {
        _filteredUsers = string.IsNullOrWhiteSpace(_searchTerm) || _searchTerm.Length < 3
            ? _users
            : _users.Where(u =>
                u.Username.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.FirstName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.LastName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.BirthPlace.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Residence.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
    }

    public class UserProxy : IUser
    {
        public Guid Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public DateTime DateOfBirth { get; set; }
        public string BirthPlace { get; set; } = string.Empty;
        public string Residence { get; set; } = string.Empty;
        public SecureString Password { get; set; } = new SecureString();
    }
}
