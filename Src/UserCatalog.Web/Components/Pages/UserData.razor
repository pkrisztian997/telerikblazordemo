@page "/users"
@using System.Xml.Serialization
@using System.Text
@using SHD.UserCatalog.BL
@using System.Security
@using System.Text.Json
@using UserCatalog.Web.Components.Pages.ViewModels
@using UserCatalog.Web.Components.Pages.ViewModels.Converters
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject UserProxyConverter UserProxyConverter

<PageTitle>Users</PageTitle>

<TelerikTextBox @bind-Value="_searchTerm"
                Placeholder="Search..."
                OnChange="@OnSearchTermChanged" />

<TelerikGrid Data="@_filteredUsers" Height="500px"
             Pageable="true"
             Sortable="true"
             FilterMode="Telerik.Blazor.GridFilterMode.None"
             SelectedItems="@_selectedUsers"
             SelectionMode="GridSelectionMode.Multiple"
             SelectedItemsChanged="@((IEnumerable<IUser> newSelected) => OnRowSelect(newSelected))">
    <GridColumns>
        <GridColumn Field="Username" Title="Username" />
        <GridColumn Field="FirstName" Title="Firstname" />
        <GridColumn Field="LastName" Title="Lastname" />
        <GridColumn Field="DateOfBirth" Title="Date of birth" />
        <GridColumn Field="BirthPlace" Title="Birth place" />
        <GridColumn Field="Residence" Title="Residence" />
    </GridColumns>
</TelerikGrid>

<div class="mt-3">
    <TelerikButton Class="btn btn-primary" OnClick="@ExportSelectedToXml"
                   Enabled="@(_selectedUsers.Any())">
        Save selected to XML
    </TelerikButton>

    <TelerikButton Class="btn btn-primary" OnClick="@ExportAllToXml"
                   Enabled="@(_users.Any())">
        Save all to XML
    </TelerikButton>

    <TelerikButton Class="btn btn-success" OnClick="@GoToDetail"
                   Enabled="@(_selectedUsers.Count() == 1)">
        Edit
    </TelerikButton>
</div>

@code {
    private IEnumerable<IUser> _users = new List<IUser>();
    private IEnumerable<IUser> _filteredUsers = new List<IUser>();

    private string _searchTerm = string.Empty;
    private IEnumerable<IUser> _selectedUsers = new List<IUser>();

    protected override async Task OnInitializedAsync()
    {
        _users = await LoadUsersAsync();
        _filteredUsers = _users;
    }

    private async Task<IEnumerable<IUser>> LoadUsersAsync()
    {
        var response = await Http.GetAsync("/api/user");
        if (!response.IsSuccessStatusCode)
        {
            return new List<IUser>();
        }

        var json = await response.Content.ReadAsStringAsync();
        return UserProxyConverter.ConvertUserListToUserProxy(json);
    }

    private void OnRowSelect(IEnumerable<IUser> users)
    {
        _selectedUsers = users;
    }

    private void ExportSelectedToXml()
    {
        ExportSelectedToXml(_selectedUsers);
    }

    private void ExportAllToXml()
    {
        ExportSelectedToXml(_users);
    }

    private void ExportSelectedToXml(IEnumerable<IUser> users)
    {
        var proxyList = users.Select(u => new UserProxy
        (
            u.Id,
            u.Username,
            u.FirstName,
            u.LastName,
            u.DateOfBirth,
            u.BirthPlace,
            u.Residence,
            u.Password
        )).ToList();

        var serializer = new XmlSerializer(typeof(List<UserProxy>));
        using var sw = new StringWriter();
        serializer.Serialize(sw, proxyList);
        var xml = sw.ToString();

        var bytes = Encoding.UTF8.GetBytes(xml);
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"users_{DateTime.Now:yyyyMMddHHmmss}.xml";
        var href = $"data:text/xml;base64,{base64}";
        JS.InvokeVoidAsync("downloadFile", href, fileName);
    }

    private void GoToDetail()
    {
        var userId = _selectedUsers.First().Id;
        Nav.NavigateTo($"/userdetail/{userId}");
    }

    private void OnSearchTermChanged(object currentValue)
    {
        _filteredUsers = string.IsNullOrWhiteSpace(_searchTerm) || _searchTerm.Length < 3
            ? _users
            : _users.Where(u =>
                u.Username.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.FirstName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.LastName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.BirthPlace.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                u.Residence.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
    }
}
